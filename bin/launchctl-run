#!/bin/bash

set -euo pipefail

service_name="$1"

get_config() {
	launchctl list "$service_name" |
		grep "$1" | sed -e "s/^[[:space:]]*\"$1\" = \(.*\);$/\1/" |
		sed -e 's/^"//' -e 's/"$//' ||
		echo
}

stdout_pid=
stdout_path="$(get_config StandardOutPath)"
if [ -f "$stdout_path" ]; then
	tail -q -n0 -f "$stdout_path" >/dev/stdout &
	stdout_pid="$!"
fi

stderr_pid=
stderr_path="$(get_config StandardErrorPath)"
if [ -f "$stderr_path" ]; then
	tail -q -n0 -f "$stderr_path" >/dev/stderr &
	stderr_pid="$!"
fi

function finish() {
	[ -z "$stdout_pid" ] || kill "$stdout_pid"
	[ -z "$stderr_pid" ] || kill "$stderr_pid"
}
trap finish EXIT

launchctl start "$service_name"
service_pid="$(get_config PID)"
while ps "$service_pid" >/dev/null; do sleep 1; done

exitstatus=$(get_config LastExitStatus)
exit "$exitstatus"
