#!/bin/bash

set -e

yaml2json() {
  ruby -rjson -ryaml -e 'puts JSON.generate(YAML.load_file(ARGF.path))' "$1"
}

TEMPLATE="$(yaml2json "$1")"

pushd "$(dirname $1)" >/dev/null

if test -t 0; then
  EVENT_BODY="{}"
else
  EVENT_BODY="$(cat)"
fi

NAME="$(echo "$TEMPLATE" | jq --raw-output ".Resources | keys_unsorted | first")"
HANDLER="$(echo "$TEMPLATE" | jq --raw-output '.Resources[$name].Properties.Handler' --arg name "$NAME")"
RUNTIME="$(echo "$TEMPLATE" | jq --raw-output '.Resources[$name].Properties.Runtime' --arg name "$NAME")"

docker run --rm --volume "$PWD":/var/task "lambci/lambda:$RUNTIME" "$HANDLER" "$EVENT_BODY" | jq
