#!/bin/bash
# Usage: docker-volume-export --output <path> [--host <hostname>] <volume>

set -e

volume=""
output=""
host=""

while [ -n "$1" ]; do
  case "$1" in
  --help | -h )
    sed -ne '/^#/!q;s/.\{1,2\}//;1d;p' < "$0"
    exit 0
    ;;
  '--output'* )
    output="$2"
    shift 2
    ;;
  '--host'* )
    host="$2"
    shift 2
    ;;
  * )
    volume="$1"
    shift 1
  esac
done

if [ -z "$volume" ] || [ -z "$output" ]; then
  "$0" --help | head -1 >&2
  exit 1
fi

gz=""
if [[ "$output" == *.gz ]]; then
  gz="z"
fi

cmd="docker run --rm --volume $volume:/mnt/$volume alpine ash -c 'cd /mnt/$volume ; tar -c${gz}f - .'"

if [ -n "$host" ]; then
  ssh "$host" "$cmd" > "$output"
else
  eval "$cmd" > "$output"
fi
