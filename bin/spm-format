#!/bin/bash

set -e -o pipefail

format() {
	tmpfile="$(mktemp)"
	cleanup() {
		rm -f "$tmpfile"
	}
	trap cleanup EXIT

	swift-format "$1" | swiftformat stdin --config .swiftformat --quiet --output "$tmpfile"

	if ! cmp --silent "$1" "$tmpfile"; then
		echo "$1" >&2
		mv "$tmpfile" "$1"
	fi
}
export -f format

find . -type f -iname "*.swift" ! -path "./.build/*" |
	tr '\n' '\0' |
	xargs -0 -n1 -P10 -I '{}' bash -c 'format "$@"' _ {}
