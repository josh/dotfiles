#!/bin/bash

set -e

yaml2json() {
  ruby -rjson -ryaml -e 'puts JSON.generate(YAML.load_file(ARGF.path))' "$1"
}

YAML="$1"
[ -n "$YAML" ] || YAML=$(echo ./*.yaml)
JSON="$(yaml2json "$YAML")"

pushd "$(dirname $YAML)" >/dev/null

NAME="$(echo "$JSON" | jq --raw-output ".Resources | keys_unsorted | first")"
HANDLER="$(echo "$JSON" | jq --raw-output '.Resources[$name].Properties.Handler' --arg name "$NAME")"
RUNTIME="$(echo "$JSON" | jq --raw-output '.Resources[$name].Properties.Runtime' --arg name "$NAME")"

echo "+ zipping" >&2
rm -f function.zip
zip function.zip * >&2

echo "+ uploading"
aws lambda update-function-code --function-name "$NAME" --zip-file "fileb://function.zip" >/dev/null
rm function.zip
