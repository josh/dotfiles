#!/bin/bash

set -euf -o pipefail

run() {
	docker run --rm -v "$(pwd)":/src -w /src norionomura/jazzy:0.13.1_swift-5.1.3 "$@"
}

spm_module() {
	swift package describe --type json |
		jq --raw-output '.targets[] | select(.type == "library") | .name' |
		head -n1
}

DEFAULT_MODULE="$(spm_module)"
MODULE="${1:-$DEFAULT_MODULE}"
DOC=".build/sourcekitten-doc.json"
run sourcekitten doc --spm-module "$MODULE" >"$DOC"
run jazzy --clean --sourcekitten-sourcefile "$DOC"
