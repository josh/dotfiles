#!/bin/bash

set -eu -o pipefail
set -x

pushd /tmp

rm -rf /tmp/ipfs-git-repo
git clone --bare "$1" /tmp/ipfs-git-repo
pushd /tmp/ipfs-git-repo

git remote rm origin

unpack() {
	set +x
	mv ./objects/pack/*.pack .
	git unpack-objects <./*.pack
	rm -f ./*.pack
	rm -rf ./objects/pack ./objects/info
	set -x
}

unpack_refs() {
	set +x
	IFS=$'\n'
	for f in $(git show-ref); do
		ref="$(echo "$f" | cut -c42-)"
		sha="$(echo "$f" | cut -c1-40)"
		mkdir -p "$(dirname "$ref")"
		echo "$sha" >"$ref"
	done
	rm -f packed-refs
	set -x
}

unpack
unpack_refs

git fsck
git update-server-info

ipfs add --recursive .

popd
rm -rf /tmp/ipfs-git-repo
